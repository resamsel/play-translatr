<mat-form-field
  #formField
  [appearance]="appearance"
  [color]="color"
  class="search search-field-{{appearance}}"
>
  <ng-content select="[matPrefix]"></ng-content>
  <mat-chip-list #chipList>
    <mat-chip
      (removed)="onRemoved(option.key)"
      *ngFor="let option of options"
      [removable]="true"
      [selectable]="false"
      class="option selected-option"
    >
      <span class="ellipsis" matTooltip="{{option.title || option.key}}: {{option.value}}">
        <ng-container *ngIf="option.title; else selectedKeyValue">
          <span class="{{option.type === 'boolean' ? 'value' : 'type'}}">{{option.title}}</span>
          <span
            *ngIf="option.value !== undefined && option.value !== null && !option.allowEmpty"
            class="value"
          >{{option.value.toString()}}</span>
        </ng-container>
        <ng-template #selectedKeyValue>
          <span class="type">{{option.key}}</span>
          <span
            *ngIf="option.value !== undefined && option.value !== null"
            class="value"
          >{{option.value.toString()}}</span>
        </ng-template>
      </span>
      <mat-icon matChipRemove>close</mat-icon>
    </mat-chip>
    <ng-content></ng-content>
    <input
      #autocompleteInput
      matInput
      [formControl]="filterControl"
      [matAutocomplete]="auto"
      [matChipInputFor]="chipList"
      autocomplete="off"
      placeholder="Filter"
      type="search"
    />
    <button
      (click)="autocompleteTrigger.openPanel()"
      *ngIf="autocompleteTrigger && !autocompleteTrigger.panelOpen && autocompleteOptions.length > 0"
      aria-label="Expand filter bar"
      mat-icon-button
      matSuffix
    >
      <mat-icon>expand_more</mat-icon>
    </button>
    <button
      (click)="autocompleteTrigger.closePanel()"
      *ngIf="autocompleteTrigger && autocompleteTrigger.panelOpen"
      aria-label="Collapse filter bar"
      mat-icon-button
      matSuffix
    >
      <mat-icon>expand_less</mat-icon>
    </button>
  </mat-chip-list>
  <mat-autocomplete
    #auto="matAutocomplete"
    [autoActiveFirstOption]="true"
    [displayWith]="displayFn"
    (closed)="renderer.removeClass(formField._elementRef.nativeElement, 'autocomplete-open')"
    (opened)="renderer.addClass(formField._elementRef.nativeElement, 'autocomplete-open')"
    class="mat-elevation-z1"
  >
    <mat-option
      (onSelectionChange)="onAutocompleteSelected($event)"
      *ngFor="let option of autocompleteOptions"
      [value]="option"
      class="option autocomplete-option"
    >
      <ng-container *ngIf="option.title; else autocompleteKeyValue">
        <span>{{option.title}}</span>
        <span
          *ngIf="option.value !== undefined
              && option.value !== null
              && option.value !== ''
              && !option.allowEmpty"
        >: {{option.value.toString()}}</span>
      </ng-container>
      <ng-template #autocompleteKeyValue>
        <span class="type">{{option.key}}</span>
        <span class="value">{{option.value.toString()}}</span>
      </ng-template>
    </mat-option>
  </mat-autocomplete>
</mat-form-field>
